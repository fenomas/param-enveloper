function N(F,R){if(F.length===0)return-1;if(R<=F[0].t0)return-1;return F.findIndex((f)=>R<=f.t1)}function T(F,R){const f=R-F.t0;switch(F.type){case"HOLD":return F.v0;case"SWEEP":return y(f,F.v0,F.tgt,F.k);case"RAMP_LINEAR":return I(f,F.v0,F.v1,F.t1-F.t0);case"RAMP_EXPO":return w(f,F.v0,F.v1,F.t1-F.t0)}}var y=function(F=0.1,R=0,f=1,H=0.1){return f+(R-f)*Math.exp(-F/H)},I=function(F=0.1,R=0,f=0,H=1){return R+(f-R)*F/H},w=function(F=0.1,R=0,f=0,H=1){return R*Math.pow(f/R,F/H)};class W{type;v0;v1;t0;t1;k;tgt;constructor(F,R,f,H,q){this.type=F,this.v0=+R,this.v1=+f,this.t0=+H,this.t1=+q,this.k=0.1,this.tgt=0.1}toString(){return`ParamEvent(${this.type}, t:${this.t0}~${this.t1} v:${this.v0}~${this.v1})`}}var Y=function(F){if(F.__paramEnveloperEvents)return F;return F.cancelScheduledValues(0),F.__paramEnveloperEvents=[new W("HOLD",F.value,F.value,0,0)],F},L=function(){console.warn("ParamEnveloper: ignoring event scheduled after an infinite sweep")},D=function(F){console.warn("ParamEnveloper: ignoring event invalid duration",F)};class U{ctx;zeroRampTarget;constructor(F){this.ctx=F,this.zeroRampTarget=0.001}initParam(F,R=0){const f=Y(F),H=f.__paramEnveloperEvents;f.cancelScheduledValues(0),H.length=0,f.setValueAtTime(R,0),H.push(new W("HOLD",R,R,0,0))}startEnvelope(F,R=0){const f=Y(F),H=f.__paramEnveloperEvents,q=H[H.length-1],J=this.ctx.currentTime,j=Math.max(R,J);if(J>=q.t1)H.length=0;else{const Q=N(H,J);if(Q>0)H.splice(0,Q)}if(H.length===0){H.push(new W("HOLD",q.v1,q.v1,0,j)),f.setValueAtTime(q.v1,j),S("start:  fresh envelope, value",q.v1," from time",j);return}const O=N(H,j);if(O<0){H.push(new W("HOLD",q.v1,q.v1,0,j)),f.setValueAtTime(q.v1,j),S("start:  envelope begins: value",q.v1,"from time",j);return}const M=H[O];if(H.length=O+1,M.t1===j){f.cancelScheduledValues(j+0.0001),S("start:  envelope begins: value",q.v1,"from time",j);return}const K=T(M,j);if(M.t1=j,M.v1=K,f.cancelScheduledValues(j),S("start:  envelope begins: value",M.v1,"from time",j),M.type==="HOLD")f.setValueAtTime(K,j),S("--set value",K,"time",j);else if(M.type==="RAMP_LINEAR")f.linearRampToValueAtTime(K,j),S("--ramp to",K,"time",j);else if(M.type==="RAMP_EXPO"){const Q=K||this.zeroRampTarget;f.exponentialRampToValueAtTime(Q,j),S("--exp ramp to",Q,"time",j)}else if(M.type==="SWEEP")f.setValueAtTime(K,j),S("--set value",K,"time",j)}addHold(F,R){if(!(R>0))return D(R);const f=Y(F),H=f.__paramEnveloperEvents,q=H[H.length-1];if(q.t1===Infinity){const K=q.t0+R;S("hold:   during sweep, start new envelope from time:",K),this.startEnvelope(f,K);return}const{v1:J,t1:j}=q,O=J,M=j+R;H.push(new W("HOLD",J,O,j,j+R)),f.setValueAtTime(O,M),S("hold:   val",O,"until time",M)}addRamp(F,R,f,H=!1){if(!(R>0))return D(R);const q=Y(F),J=q.__paramEnveloperEvents,j=J[J.length-1];if(j.t1===Infinity)return L();const O=j.t1,M=O+R;let K=j.v1,Q=f;if(H){if(K===0)K=this.zeroRampTarget;if(Q===0)Q=this.zeroRampTarget;q.exponentialRampToValueAtTime(Q,M)}else q.linearRampToValueAtTime(Q,M);const G=H?"RAMP_EXPO":"RAMP_LINEAR";J.push(new W(G,K,Q,O,M)),S("ramp:   to val",Q,"time",M,H?"exp":"linear")}addSweep(F,R,f,H){const q=Y(F),J=q.__paramEnveloperEvents,j=J[J.length-1];if(j.t1===Infinity)return L();const{t1:O,v1:M}=j;q.setTargetAtTime(f,O,H);const K=new W("SWEEP",M,f,O,Infinity);if(K.k=H,K.tgt=f,R>0&&isFinite(R))K.t1=O+R,K.v1=T(K,K.t1);J.push(K),S(`sweep: to tgt ${f} const ${H} from t ${O} to ${K.t1}`)}getValueAtTime(F,R){const H=Y(F).__paramEnveloperEvents,q=N(H,R);if(q<0){if(R<=H[0].t0)return H[0].v0;return H[H.length-1].v1}return T(H[q],R)}}var P=!1,S=P?function(...F){console.log(...F.map((R)=>{return typeof R==="number"?Math.round(R*1e4)/1e4:R}))}:()=>{};var b=function(F,R,f=0,H=0,q=0,J=0){F.addRamp(R,f,1),F.addHold(R,H),F.addRamp(R,q,0.8,!0),F.addSweep(R,-1,0,J)},$=[],k=(F,R)=>{$.push({name:F,fn:R})};k("break",(F,R,f)=>{F.startEnvelope(R,f)});k("sweep",(F,R,f)=>{F.startEnvelope(R,f),F.addRamp(R,0.5,0.9),F.addSweep(R,-1,0,0.4)});k("ramps",(F,R,f)=>{F.startEnvelope(R,f);for(let H=0;H<20;H++)F.addRamp(R,0.1,H%2?0.3:0.7)});k("adsr",(F,R,f)=>{F.startEnvelope(R,f),b(F,R,0.1,0.1,0.4,0.5)});k("release",(F,R,f)=>{F.startEnvelope(R,f),F.addSweep(R,-1,0,0.2)});var _=function(){if(Z)return;B()},B=function(){document.removeEventListener("keydown",B),document.removeEventListener("click",B);const F=new AudioContext,R=F.createOscillator(),f=F.createGain(),H=F.createGain(),q=F.createAnalyser();R.start(),R.connect(f),f.connect(H),H.connect(F.destination),f.connect(q),H.gain.setValueAtTime(0.5,0);const J=new U(F),j=f.gain;J.startEnvelope(j,0),Z={ctx:F,enveloper:J,param:j};const O=document.querySelector("canvas"),M=O.getContext("2d");M.fillStyle="#000",M.fillRect(0,0,O.width,O.height);const K=new Float32Array(256);let Q=2;const G=()=>{requestAnimationFrame(G),q.getFloatTimeDomainData(K);const X=1,z=K.reduce((E,V)=>Math.max(E,V),0)*256;M.fillStyle="#000",M.fillRect(Q,0,X,O.height),M.fillStyle="#FFF",M.fillRect(Q,O.height-z,X,z),Q=(Q+X)%O.width};G();let h=!1;const A=()=>{if(h)return;h=!0,$.at(-2)?.fn(J,j,F.currentTime+0.01)},C=()=>{h=!1,$.at(-1)?.fn(J,j,F.currentTime+0.01)};document.addEventListener("keydown",(X)=>{if(X.key!==" ")return;X.preventDefault(),A()}),document.addEventListener("keyup",(X)=>{if(X.key!==" ")return;C()})};globalThis?.document?.addEventListener("DOMContentLoaded",()=>{document.body.style.padding="1rem",document.body.style.font="17px sans-serif";const F=document.createElement("p");F.innerHTML="Press/release spacebar to start/end an envelope";const R=document.createElement("canvas");R.width=800,R.height=260,R.style.backgroundColor="black",document.body.appendChild(F),document.body.appendChild(R),document.addEventListener("keydown",B),document.addEventListener("click",B);const f=document.createElement("div");f.style.margin="20px 50px",document.body.appendChild(f),f.innerHTML="ad-hoc test cases",$.forEach(({name:H,fn:q})=>{const J=document.createElement("button");J.style.margin="10px",J.style.padding="10px",J.innerText=""+H,J.onclick=()=>{if(_(),Z)q(Z.enveloper,Z.param,Z.ctx.currentTime+0.1)},f.appendChild(J)})});var Z=null;
