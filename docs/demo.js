function S(F,R){if(F.length===0)return-1;if(R<=F[0].t0)return-1;return F.findIndex((H)=>R<=H.t1)}function T(F,R){const H=R-F.t0;switch(F.type){case"HOLD":return F.v0;case"SWEEP":return E(H,F.v0,F.tgt,F.k);case"RAMP_LINEAR":return I(H,F.v0,F.v1,F.t1-F.t0);case"RAMP_EXPO":return w(H,F.v0,F.v1,F.t1-F.t0)}}var E=function(F=0.1,R=0,H=1,f=0.1){return H+(R-H)*Math.exp(-F/f)},I=function(F=0.1,R=0,H=0,f=1){return R+(H-R)*F/f},w=function(F=0.1,R=0,H=0,f=1){return R*Math.pow(H/R,F/f)};class X{type;v0;v1;t0;t1;k;tgt;constructor(F,R,H,f,q){this.type=F,this.v0=+R,this.v1=+H,this.t0=+f,this.t1=+q,this.k=0.1,this.tgt=0.1}toString(){return`ParamEvent(${this.type}, t:${this.t0}~${this.t1} v:${this.v0}~${this.v1})`}}var Z=function(F){if(F.__paramEnveloperEvents)return F;return F.cancelScheduledValues(0),F.__paramEnveloperEvents=[new X("HOLD",F.value,F.value,0,0)],F},L=function(){console.warn("ParamEnveloper: ignoring event scheduled after an infinite sweep")},D=function(F){console.warn("ParamEnveloper: ignoring event invalid duration",F)};class U{ctx;zeroRampTarget;constructor(F){this.ctx=F,this.zeroRampTarget=0.001}initParam(F,R=0){const H=Z(F),f=H.__paramEnveloperEvents;H.cancelScheduledValues(0),f.length=0,H.setValueAtTime(R,0),f.push(new X("HOLD",R,R,0,0))}startEnvelope(F,R=0){const H=Z(F),f=H.__paramEnveloperEvents,q=f[f.length-1],J=this.ctx.currentTime,j=Math.max(R,J);if(J>=q.t1)f.length=0;else{const Q=S(f,J);if(Q>0)f.splice(0,Q)}if(f.length===0){f.push(new X("HOLD",q.v1,q.v1,0,j)),H.setValueAtTime(q.v1,j),W("start:  fresh envelope, value",q.v1," from time",j);return}const O=S(f,j);if(O<0){f.push(new X("HOLD",q.v1,q.v1,0,j)),H.setValueAtTime(q.v1,j),W("start:  envelope begins: value",q.v1,"from time",j);return}const M=f[O];if(f.length=O+1,M.t1===j){H.cancelScheduledValues(j+0.0001),W("start:  envelope begins: value",q.v1,"from time",j);return}const K=T(M,j);if(M.t1=j,M.v1=K,H.cancelScheduledValues(j),W("start:  envelope begins: value",M.v1,"from time",j),M.type==="HOLD")H.setValueAtTime(K,j),W("--set value",K,"time",j);else if(M.type==="RAMP_LINEAR")H.linearRampToValueAtTime(K,j),W("--ramp to",K,"time",j);else if(M.type==="RAMP_EXPO"){const Q=K||this.zeroRampTarget;H.exponentialRampToValueAtTime(Q,j),W("--exp ramp to",Q,"time",j)}else if(M.type==="SWEEP")H.setValueAtTime(K,j),W("--set value",K,"time",j)}addHold(F,R){if(!(R>0))return D(R);const H=Z(F),f=H.__paramEnveloperEvents,q=f[f.length-1];if(q.t1===Infinity){const K=q.t0+R;W("hold:   during sweep, start new envelope from time:",K),this.startEnvelope(H,K);return}const{v1:J,t1:j}=q,O=J,M=j+R;f.push(new X("HOLD",J,O,j,j+R)),H.setValueAtTime(O,M),W("hold:   val",O,"until time",M)}addRamp(F,R,H,f=!1){if(!(R>0))return D(R);const q=Z(F),J=q.__paramEnveloperEvents,j=J[J.length-1];if(j.t1===Infinity)return L();const O=j.t1,M=O+R;let K=j.v1,Q=H;if(f){if(K===0)K=this.zeroRampTarget;if(Q===0)Q=this.zeroRampTarget;q.exponentialRampToValueAtTime(Q,M)}else q.linearRampToValueAtTime(Q,M);const N=f?"RAMP_EXPO":"RAMP_LINEAR";J.push(new X(N,K,Q,O,M)),W("ramp:   to val",Q,"time",M,f?"exp":"linear")}addSweep(F,R,H,f){const q=Z(F),J=q.__paramEnveloperEvents,j=J[J.length-1];if(j.t1===Infinity)return L();const{t1:O,v1:M}=j;q.setTargetAtTime(H,O,f);const K=new X("SWEEP",M,H,O,Infinity);if(K.k=f,K.tgt=H,R>0&&isFinite(R))K.t1=O+R,K.v1=T(K,K.t1);J.push(K),W(`sweep: to tgt ${H} const ${f} from t ${O} to ${K.t1}`)}getValueAtTime(F,R){const f=Z(F).__paramEnveloperEvents,q=S(f,R);if(q<0){if(R<=f[0].t0)return f[0].v0;return f[f.length-1].v1}return T(f[q],R)}}var P=!1,W=P?function(...F){console.log(...F.map((R)=>{return typeof R==="number"?Math.round(R*1e4)/1e4:R}))}:()=>{};var k=[],B=(F,R)=>{k.push({name:F,fn:R})};B("break",(F,R,H)=>{F.startEnvelope(R,H)});B("sweep",(F,R,H)=>{F.startEnvelope(R,H),F.addRamp(R,0.5,0.9),F.addSweep(R,-1,0,0.4)});B("ramps",(F,R,H)=>{F.startEnvelope(R,H);for(let f=0;f<20;f++)F.addRamp(R,0.1,f%2?0.3:0.7)});B("adsr",(F,R,H)=>{F.startEnvelope(R,H),F.addRamp(R,0.15,1),F.addHold(R,0.05),F.addRamp(R,0.3,0.5,!0)});B("release",(F,R,H)=>{F.startEnvelope(R,H),F.addSweep(R,-1,0,0.2)});var b=function(){if($)return;G()},G=function(){document.removeEventListener("keydown",G),document.removeEventListener("click",G);const F=new AudioContext,R=F.createOscillator(),H=F.createGain(),f=F.createGain(),q=F.createAnalyser();R.start(),R.connect(H),H.connect(f),f.connect(F.destination),H.connect(q),f.gain.setValueAtTime(0.5,0);const J=new U(F),j=H.gain;J.initParam(j,0),J.startEnvelope(j,0),J.addRamp(j,0.04,0.5),J.addSweep(j,0.5,0,0.5),$={ctx:F,enveloper:J,param:j};const O=document.querySelector("canvas"),M=O.getContext("2d");M.fillStyle="#000",M.fillRect(0,0,O.width,O.height);const K=new Float32Array(256);let Q=2;const N=()=>{requestAnimationFrame(N),q.getFloatTimeDomainData(K);const Y=1,z=K.reduce((V,y)=>Math.max(V,y),0)*256;M.fillStyle="#000",M.fillRect(Q,0,Y,O.height),M.fillStyle="#FFF",M.fillRect(Q,O.height-z,Y,z),Q=(Q+Y)%O.width};N();let h=!1;const A=()=>{if(h)return;h=!0,k.at(-2)?.fn(J,j,F.currentTime+0.01)},C=()=>{h=!1,k.at(-1)?.fn(J,j,F.currentTime+0.01)};document.addEventListener("keydown",(Y)=>{if(Y.key!==" ")return;Y.preventDefault(),A()}),document.addEventListener("keyup",(Y)=>{if(Y.key!==" ")return;C()})};globalThis?.document?.addEventListener("DOMContentLoaded",()=>{document.body.style.padding="1rem",document.body.style.font="17px sans-serif";const F=document.createElement("p");F.innerHTML="Press/release spacebar to start/end an envelope";const R=document.createElement("canvas");R.width=800,R.height=260,R.style.backgroundColor="black",document.body.appendChild(F),document.body.appendChild(R),document.addEventListener("keydown",G),document.addEventListener("click",G);const H=document.createElement("div");H.style.margin="20px 50px",document.body.appendChild(H),H.innerHTML="ad-hoc test cases",k.forEach(({name:f,fn:q})=>{const J=document.createElement("button");J.style.margin="10px",J.style.padding="10px",J.innerText=""+f,J.onclick=()=>{if(b(),$)q($.enveloper,$.param,$.ctx.currentTime+0.1)},H.appendChild(J)})});var $=null;
